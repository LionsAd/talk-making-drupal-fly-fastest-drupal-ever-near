<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Making Drupal fly — The fastest Drupal ever is near!</title>

		<meta name="author" content="Fabian Franz &amp; Wim Leers">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="src/reveal/css/reveal.css">
		<link rel="stylesheet" href="src/reveal/css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="src/reveal/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'src/reveal/css/print/pdf.css' : 'src/reveal/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="src/reveal/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Making Drupal fly</h1>
					<h3>The fastest Drupal ever is near!</h3>
					<br>
					<p>
						<ul>
							<li>Fabian Franz <small style="vertical-align: baseline">(<a href="https://tag1consulting.com/">Tag1 Consulting</a> — <a href="https://twitter.com/fabianfranz">@fabianfranz</a>)</small></li>
							<li>Wim Leers <small style="vertical-align: baseline">(<a href="https://acquia.com/">Acquia</a> — <a href="https://twitter.com/wimleers">@wimleers</a> — <a href="http://wimleers.com/">wimleers.com</a>)</small></li>
						</ul>
					</p>
				</section>

				<!-- Fabian -->
				<section>
					<h2>Demo + Intro</h2>
				</section>
				
				<!-- Wim -->
				<section>
					<section>
						<h2>The thought process</h2>
						<p>The theory of how we make Drupal fast</p>
					</section>
					<section>
						<h3>Dependencies, dependencies, dependencies!</h3>
						<ul class="fragment">
							<li>Drupal 7 didn't track <em>any</em> dependencies
							<li class="fragment">e.g. <a href="https://api.drupal.org/api/drupal/includes%21common.inc/function/url/7"><code>url()</code></a>'s output depended on:
								<ul style="font-size: 70%">
									<li class="fragment"><code>&lt;front&gt;</code> configuration
									<li class="fragment">HTTPS configuration
									<li class="fragment">clean URL configuration
									<li class="fragment">current site in multisite
									<li class="fragment">current host name
									<li class="fragment">path processing
										<ul>
											<li class="fragment">negotiated interface language
											<li class="fragment">negotiated URL language
											<li class="fragment">…</li>
										</ul>
									</li>
								</ul>
							</li>
							<li class="fragment">⇒ impossible to <del>cache</del> <ins>invalidate</ins></li>
							<li class="fragment"><em> … yet many of us did it anyway!</em></li>
						</ul>
					</section>
					<section>
						<h3>Correct invalidation in Drupal 8</h3>
						<ul>
							<li>Cache tags <small class="fragment">(data dependencies)</small>
							<li>Cache contexts <small class="fragment">(context dependencies)</small>
							<li>Cache max-age <small class="fragment">(time dependencies)</small>
						</ul>
						<div class="fragment">
							<p>+</p>
							<p>Cacheability bubbled during rendering!</p>
						</div>
					</section>
					<section>
						<h3>In practice</h3>
						<p>Try to make this thought process a habit:</p>
					</section>
					<section>
						<h3>1.</h3>
						<blockquote>I'm rendering something. That means I must think of cacheability!</blockquote>
					</section>
					<section>
						<h3>2.</h3>
						<blockquote>Is this something that's expensive to render, and therefore is worth caching?</blockquote>
						<p>↪︎ If "yes": <strong>cache keys</strong></p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['keys'] = ['node', 5, 'teaser'];</code></pre>
					</section>
					<section>
						<h3>3.</h3>
						<blockquote>Does the representation of the thing I'm rendering vary per combination of permissions, per URL, per interface language, per … something?</blockquote>
						<p>↪︎ If "yes": <strong>cache contexts</strong></p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['contexts'][] = 'user.permissions';
$build['#cache']['contexts'][] = 'url';
</code></pre>
						<p class="fragment"><small>~ HTTP's <code>Vary</code> header</small></p>
					</section>
					<section>
						<h3>4.</h3>
						<blockquote>What causes the representation of the thing I'm rendering become outdated?</blockquote>
						<p>↪︎ If "yes": <strong>cache tags</strong></p>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['tags'][] = 'node:5';
$build['#cache']['tags'][] = 'user:3';
$build['#cache']['tags'][] = 'taxonomy_term:23';
</code></pre>
					</section>
					<section>
						<h3>5.</h3>
						<blockquote>When does the representation of the thing I'm rendering become outdated?</blockquote>
						↪︎ If "yes": <strong>cache max-age</strong>
						<pre class="fragment" style="margin-top: 3em; width: 70%"><code class="php">$build['#cache']['max-age'] = Cache::PERMANENT;</code></pre>
						<p class="fragment"><small>~ HTTP's <code>Cache-Control: max-age</code> header</small></p>
					</section>
					<section>
						<p>To make it easier:</p>
						<p><small><code class="php">Renderer::addCacheableDependency($dependency)</code></small></p>
						<pre class="fragment"><code class="php">$site_config = $this->config->get('system.site');

$build = [
  '#markup' => t('Welcome to @site!', $site_config->get('name')),
];
$this->renderer->addCacheableDependency($site_config)</code></pre>
					</section>
					<section>
						<h3>If Drupal pages were ships…</h3>
						<p>(Drupal rendering a page ~ building a ship)</p>
					</section>
					<section>
						<h3>… then this could be Drupal 8…</h3>
						<figure>
							<img src="img/lego-ship-drupal8.jpg">
							<figcaption>Assembled from components. Clear dependencies.</figcaption>
						</figure>
					</section>
					<section>
						<h3>… and this would be Drupal 7</h3>
						<figure>
							<img src="img/lego-ship-drupal7.jpg">
							<figcaption>Assembled from seemingly random pieces. <em>But it is a boat!</em></figcaption>
						</figure>
					</section>
				</section>
				
				<!-- Fabian + Wim -->
				<section>
					<section>
						<h2>Scenarios + pitfalls</h2>
					</section>
					<section>
						<h3>Depending on configuration?</h3>
						<p>Don't forget to add its cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($config)</code></pre></p>
					</section>
					<section>
						<h3>Depending on an entity?</h3>
						<p>Don't forget to add its cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($entity)</code></pre></p>
					</section>
					<section>
						<h3>Depending on a field of an entity?</h3>
						<p>Don't forget to add the entity's cache tags!</p>
						<p><pre style="width: 70%"><code class="php">Renderer::addCacheableDependency($entity)</code></pre></p>
					</section>
					<section>
						<h3>Uncacheable data?</h3>
						<p>Don't forget to set max-age to zero!</p>
						<p><pre style="width: 50%"><code class="php">$build['#cache']['max-age'] = 0;</code></pre></p>
					</section>
					<section>
						<h3>Manually rendering a link?</h3>
						<p>Either:</p>
						<ul>
							<li>Use Twig:
								<pre><code class="twig" style="width: 110%">{{ link(something.title, something.url) }}</code></pre>
							</li>
							<li>Use <code>#type => link</code>:
								<pre><code class="php" style="width: 110%">$build['link'] = [
  '#type' => 'link',
  '#title' => 'Drupal',
  '#url' => Url::fromUri('https://drupal.org'),
];</code></pre>
							</li>
						</ul>
					</section>
				</section>

				<!-- Fabian + Wim -->
				<section>
					<h2>Q&amp;A</h2>
				</section>

			</div>

		</div>

		<script src="src/reveal/lib/js/head.min.js"></script>
		<script src="src/reveal/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'src/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'src/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'src/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'src/reveal/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'src/reveal/plugin/zoom-js/zoom.js', async: true },
					{ src: 'src/reveal/plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
